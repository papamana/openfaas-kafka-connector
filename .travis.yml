language: node_js

node_js:
  - "10"

dist: xenial

cache: npm

services:
  - docker

before_install:
  - echo always-auth=true > .npmrc
  - echo registry=https://packagecloud.io/ratehub/npm/npm/ >> .npmrc
  - echo //packagecloud.io/ratehub/npm/npm/:_authToken=${PACKAGECLOUD_TOKEN} >> .npmrc

script:
  - export VERSION=`cat $TRAVIS_BUILD_DIR/package.json | jq -r '.version'`
  - export DOCKER_TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo $VERSION; else echo $VERSION-$TRAVIS_BRANCH-r1; fi`
  - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
  - docker build -t ratehub/faas-connector:$DOCKER_TAG .
  - docker push ratehub/faas-connector
  - if ([[ "$TRAVIS_BRANCH" == "master" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]]);
      then
        docker tag ratehub/faas-connector:$DOCKER_TAG ratehub/faas-connector:latest;
        docker push ratehub/faas-connector:latest;
    fi
